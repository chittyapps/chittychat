#!/bin/bash

# CHITTYPASS QA & PENETRATION TESTING SUITE
# Comprehensive security testing for ChittyPass password manager
# Service #35 in ChittyChat unified platform

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
BASE_URL="${CHITTYPASS_URL:-https://gateway.chitty.cc}"
API_BASE="${BASE_URL}/pass"
TEST_EMAIL="qa-test-$(date +%s)@chittypass.test"
TEST_PASSWORD="TestP@ssw0rd!2025"
PENTEST_REPORT="chittypass-pentest-$(date +%Y%m%d-%H%M%S).json"

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}     ChittyPass QA & Penetration Testing       ${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Initialize test results (using arrays for macOS compatibility)
TEST_RESULTS=()
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0
VULNERABILITIES=()

# Function to record test result
record_test() {
    local test_name="$1"
    local status="$2"
    local details="$3"

    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    TEST_RESULTS+=("$test_name:$status:$details")

    if [[ "$status" == "PASS" ]]; then
        PASSED_TESTS=$((PASSED_TESTS + 1))
        echo -e "${GREEN}‚úÖ $test_name${NC}"
    else
        FAILED_TESTS=$((FAILED_TESTS + 1))
        echo -e "${RED}‚ùå $test_name${NC}"
        echo -e "   ${YELLOW}Details: $details${NC}"

        # Add to vulnerabilities if it's a security issue
        if [[ "$test_name" == *"Security"* ]] || [[ "$test_name" == *"Injection"* ]]; then
            VULNERABILITIES+=("$test_name: $details")
        fi
    fi
}

echo -e "\n${YELLOW}üîç Phase 1: Service Health & Availability${NC}"
echo "============================================"

# Test 1: Service Health Check
echo -n "Testing service health endpoint... "
HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" "$API_BASE/health" || echo "000")
HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)

if [[ "$HTTP_CODE" == "200" ]]; then
    record_test "Service Health Check" "PASS" "Service is healthy"
else
    record_test "Service Health Check" "FAIL" "HTTP $HTTP_CODE - Service unavailable"
fi

# Test 2: CORS Headers
echo -n "Testing CORS headers... "
CORS_HEADERS=$(curl -s -I -X OPTIONS "$API_BASE/auth/login" | grep -i "access-control" || echo "")

if [[ -n "$CORS_HEADERS" ]]; then
    record_test "CORS Configuration" "PASS" "CORS headers present"
else
    record_test "CORS Configuration" "FAIL" "Missing CORS headers"
fi

echo -e "\n${YELLOW}üîê Phase 2: Authentication Testing${NC}"
echo "========================================"

# Test 3: User Registration
echo -n "Testing user registration... "
REGISTER_RESPONSE=$(curl -s -X POST "$API_BASE/auth/register" \
    -H "Content-Type: application/json" \
    -d "{\"email\":\"$TEST_EMAIL\",\"password\":\"$TEST_PASSWORD\"}" || echo "{}")

if [[ "$REGISTER_RESPONSE" == *"success\":true"* ]] || [[ "$REGISTER_RESPONSE" == *"already exists"* ]]; then
    record_test "User Registration" "PASS" "Registration endpoint functional"

    # Extract token if registration was successful
    TOKEN=$(echo "$REGISTER_RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4 || echo "")
else
    record_test "User Registration" "FAIL" "Registration failed"
fi

# Test 4: User Login
echo -n "Testing user login... "
LOGIN_RESPONSE=$(curl -s -X POST "$API_BASE/auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"email\":\"$TEST_EMAIL\",\"password\":\"$TEST_PASSWORD\"}" || echo "{}")

if [[ "$LOGIN_RESPONSE" == *"token"* ]]; then
    record_test "User Login" "PASS" "Login successful"
    TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
else
    record_test "User Login" "FAIL" "Login failed"
fi

# Test 5: Invalid Credentials
echo -n "Testing invalid credentials... "
INVALID_LOGIN=$(curl -s -X POST "$API_BASE/auth/login" \
    -H "Content-Type: application/json" \
    -d '{"email":"invalid@test.com","password":"wrongpass"}' || echo "{}")

if [[ "$INVALID_LOGIN" == *"error"* ]] || [[ "$INVALID_LOGIN" == *"401"* ]]; then
    record_test "Invalid Credentials Handling" "PASS" "Properly rejects invalid credentials"
else
    record_test "Invalid Credentials Handling" "FAIL" "Does not properly handle invalid credentials"
fi

echo -e "\n${YELLOW}üõ°Ô∏è Phase 3: Security & Penetration Testing${NC}"
echo "============================================="

# Test 6: SQL Injection
echo -n "Testing SQL injection vulnerability... "
SQL_INJECTION_PAYLOAD='{"email":"test\"; DROP TABLE users; --","password":"test"}'
SQL_RESPONSE=$(curl -s -X POST "$API_BASE/auth/login" \
    -H "Content-Type: application/json" \
    -d "$SQL_INJECTION_PAYLOAD" || echo "{}")

if [[ "$SQL_RESPONSE" == *"DROP TABLE"* ]] || [[ "$SQL_RESPONSE" == *"syntax error"* ]]; then
    record_test "SQL Injection Protection" "FAIL" "Vulnerable to SQL injection"
else
    record_test "SQL Injection Protection" "PASS" "Protected against SQL injection"
fi

# Test 7: XSS Protection
echo -n "Testing XSS vulnerability... "
XSS_PAYLOAD='{"email":"<script>alert(\"XSS\")</script>","password":"test"}'
XSS_RESPONSE=$(curl -s -X POST "$API_BASE/auth/register" \
    -H "Content-Type: application/json" \
    -d "$XSS_PAYLOAD" || echo "{}")

if [[ "$XSS_RESPONSE" == *"<script>"* ]]; then
    record_test "XSS Protection" "FAIL" "Vulnerable to XSS - unescaped script tags"
else
    record_test "XSS Protection" "PASS" "Protected against XSS"
fi

# Test 8: Password Strength Validation
echo -n "Testing weak password rejection... "
WEAK_PASSWORD='{"email":"weakpass@test.com","password":"123"}'
WEAK_RESPONSE=$(curl -s -X POST "$API_BASE/auth/register" \
    -H "Content-Type: application/json" \
    -d "$WEAK_PASSWORD" || echo "{}")

if [[ "$WEAK_RESPONSE" == *"success\":true"* ]]; then
    record_test "Password Strength Validation" "FAIL" "Accepts weak passwords"
else
    record_test "Password Strength Validation" "PASS" "Rejects weak passwords"
fi

# Test 9: Rate Limiting
echo -n "Testing rate limiting... "
RATE_LIMITED=false
for i in {1..50}; do
    RATE_RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$API_BASE/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"email":"ratelimit@test.com","password":"test"}')

    if [[ "$RATE_RESPONSE" == "429" ]]; then
        RATE_LIMITED=true
        break
    fi
done

if [[ "$RATE_LIMITED" == true ]]; then
    record_test "Rate Limiting" "PASS" "Rate limiting is active"
else
    record_test "Rate Limiting" "FAIL" "No rate limiting detected - DDoS vulnerability"
fi

# Test 10: JWT Token Security
echo -n "Testing JWT token security... "
if [[ -n "$TOKEN" ]]; then
    # Check if token has proper structure
    if [[ "$TOKEN" =~ ^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$ ]]; then
        record_test "JWT Token Structure" "PASS" "Valid JWT structure"
    else
        record_test "JWT Token Structure" "FAIL" "Invalid JWT structure"
    fi
else
    record_test "JWT Token Structure" "SKIP" "No token available"
fi

echo -e "\n${YELLOW}üîë Phase 4: Password Management Testing${NC}"
echo "==========================================="

# Test 11: Password Storage
if [[ -n "$TOKEN" ]]; then
    echo -n "Testing password storage... "
    STORE_RESPONSE=$(curl -s -X POST "$API_BASE/passwords" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"title":"Test Site","url":"https://test.com","username":"testuser","password":"TestP@ss123"}' || echo "{}")

    if [[ "$STORE_RESPONSE" == *"success\":true"* ]] || [[ "$STORE_RESPONSE" == *"passwordId"* ]]; then
        record_test "Password Storage" "PASS" "Can store passwords"
        PASSWORD_ID=$(echo "$STORE_RESPONSE" | grep -o '"passwordId":"[^"]*' | cut -d'"' -f4)
    else
        record_test "Password Storage" "FAIL" "Cannot store passwords"
    fi
fi

# Test 12: Password Retrieval
if [[ -n "$TOKEN" ]]; then
    echo -n "Testing password retrieval... "
    LIST_RESPONSE=$(curl -s -X GET "$API_BASE/passwords" \
        -H "Authorization: Bearer $TOKEN" || echo "{}")

    if [[ "$LIST_RESPONSE" == *"passwords"* ]]; then
        record_test "Password Retrieval" "PASS" "Can retrieve passwords"
    else
        record_test "Password Retrieval" "FAIL" "Cannot retrieve passwords"
    fi
fi

# Test 13: Unauthorized Access
echo -n "Testing unauthorized access... "
UNAUTH_RESPONSE=$(curl -s -X GET "$API_BASE/passwords" \
    -H "Authorization: Bearer invalid_token" || echo "{}")

if [[ "$UNAUTH_RESPONSE" == *"error"* ]] || [[ "$UNAUTH_RESPONSE" == *"401"* ]] || [[ "$UNAUTH_RESPONSE" == *"unauthorized"* ]]; then
    record_test "Unauthorized Access Protection" "PASS" "Properly blocks unauthorized access"
else
    record_test "Unauthorized Access Protection" "FAIL" "Does not block unauthorized access"
fi

echo -e "\n${YELLOW}üî¨ Phase 5: Encryption Testing${NC}"
echo "===================================="

# Test 14: Password Generation
echo -n "Testing password generation... "
GEN_RESPONSE=$(curl -s "$API_BASE/generate" || echo "{}")

if [[ "$GEN_RESPONSE" == *"password"* ]]; then
    GENERATED_PASS=$(echo "$GEN_RESPONSE" | grep -o '"password":"[^"]*' | cut -d'"' -f4)

    # Check password complexity
    if [[ ${#GENERATED_PASS} -ge 12 ]] && [[ "$GENERATED_PASS" =~ [A-Z] ]] && [[ "$GENERATED_PASS" =~ [a-z] ]] && [[ "$GENERATED_PASS" =~ [0-9] ]]; then
        record_test "Password Generation" "PASS" "Generates strong passwords"
    else
        record_test "Password Generation" "FAIL" "Generated passwords are weak"
    fi
else
    record_test "Password Generation" "FAIL" "Password generation not working"
fi

# Test 15: HTTPS Only
echo -n "Testing HTTPS enforcement... "
HTTP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "http://gateway.chitty.cc/pass" || echo "000")

if [[ "$HTTP_RESPONSE" == "301" ]] || [[ "$HTTP_RESPONSE" == "302" ]] || [[ "$HTTP_RESPONSE" == "000" ]]; then
    record_test "HTTPS Enforcement" "PASS" "HTTPS is enforced"
else
    record_test "HTTPS Enforcement" "FAIL" "HTTP is allowed - security risk"
fi

echo -e "\n${YELLOW}üéØ Phase 6: Performance Testing${NC}"
echo "===================================="

# Test 16: Response Time
echo -n "Testing response time... "
START_TIME=$(date +%s%N)
curl -s -o /dev/null "$API_BASE/health"
END_TIME=$(date +%s%N)
RESPONSE_TIME=$(( ($END_TIME - $START_TIME) / 1000000 ))

if [[ $RESPONSE_TIME -lt 1000 ]]; then
    record_test "Response Time" "PASS" "${RESPONSE_TIME}ms - Good performance"
else
    record_test "Response Time" "FAIL" "${RESPONSE_TIME}ms - Slow response"
fi

# Test 17: Content Security Policy
echo -n "Testing Content Security Policy... "
CSP_HEADER=$(curl -s -I "$API_BASE" | grep -i "content-security-policy" || echo "")

if [[ -n "$CSP_HEADER" ]]; then
    record_test "Content Security Policy" "PASS" "CSP header present"
else
    record_test "Content Security Policy" "FAIL" "Missing CSP header"
fi

echo -e "\n${BLUE}================================================${NC}"
echo -e "${BLUE}                TEST SUMMARY                    ${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""
echo -e "Total Tests: ${TOTAL_TESTS}"
echo -e "${GREEN}Passed: ${PASSED_TESTS}${NC}"
echo -e "${RED}Failed: ${FAILED_TESTS}${NC}"
echo -e "Success Rate: $(( (PASSED_TESTS * 100) / TOTAL_TESTS ))%"
echo ""

# Generate JSON report
cat > "$PENTEST_REPORT" << EOF
{
  "service": "ChittyPass",
  "version": "1.0.0",
  "service_number": 35,
  "test_date": "$(date -Iseconds)",
  "test_environment": "$BASE_URL",
  "summary": {
    "total_tests": $TOTAL_TESTS,
    "passed": $PASSED_TESTS,
    "failed": $FAILED_TESTS,
    "success_rate": $(( (PASSED_TESTS * 100) / TOTAL_TESTS ))
  },
  "vulnerabilities": [
EOF

if [[ ${#VULNERABILITIES[@]} -gt 0 ]]; then
    echo -e "${RED}‚ö†Ô∏è  SECURITY VULNERABILITIES FOUND:${NC}"
    for vuln in "${VULNERABILITIES[@]}"; do
        echo -e "${RED}   ‚Ä¢ $vuln${NC}"
        echo "    \"$vuln\"," >> "$PENTEST_REPORT"
    done

    # Remove trailing comma
    sed -i '' -e '$ s/,$//' "$PENTEST_REPORT" 2>/dev/null || sed -i '$ s/,$//' "$PENTEST_REPORT"
else
    echo -e "${GREEN}‚úÖ No critical vulnerabilities found${NC}"
fi

cat >> "$PENTEST_REPORT" << EOF
  ],
  "recommendations": [
    "Implement rate limiting on all endpoints",
    "Add Content Security Policy headers",
    "Enforce strong password requirements",
    "Add CAPTCHA for registration",
    "Implement session timeout",
    "Add audit logging for all operations",
    "Use bcrypt or argon2 for password hashing",
    "Implement 2FA support"
  ],
  "test_results": {
EOF

# Add individual test results
for result in "${TEST_RESULTS[@]}"; do
    IFS=':' read -r test_name status details <<< "$result"
    echo "    \"$test_name\": {" >> "$PENTEST_REPORT"
    echo "      \"status\": \"$status\"," >> "$PENTEST_REPORT"
    echo "      \"details\": \"$details\"" >> "$PENTEST_REPORT"
    echo "    }," >> "$PENTEST_REPORT"
done

# Remove trailing comma and close JSON
sed -i '' -e '$ s/,$//' "$PENTEST_REPORT" 2>/dev/null || sed -i '$ s/,$//' "$PENTEST_REPORT"

cat >> "$PENTEST_REPORT" << EOF
  },
  "compliance": {
    "OWASP_Top_10": {
      "A01_Broken_Access_Control": "TESTED",
      "A02_Cryptographic_Failures": "TESTED",
      "A03_Injection": "TESTED",
      "A04_Insecure_Design": "PARTIALLY_TESTED",
      "A05_Security_Misconfiguration": "TESTED",
      "A06_Vulnerable_Components": "NOT_TESTED",
      "A07_Authentication_Failures": "TESTED",
      "A08_Data_Integrity_Failures": "PARTIALLY_TESTED",
      "A09_Security_Logging_Failures": "NOT_TESTED",
      "A10_SSRF": "NOT_TESTED"
    }
  }
}
EOF

echo ""
echo -e "${BLUE}üìÑ Detailed report saved to: $PENTEST_REPORT${NC}"
echo ""

# Exit with appropriate code
if [[ $FAILED_TESTS -gt 0 ]]; then
    if [[ ${#VULNERABILITIES[@]} -gt 0 ]]; then
        echo -e "${RED}‚ùå CRITICAL: Security vulnerabilities detected!${NC}"
        exit 2
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Some tests failed but no critical vulnerabilities${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}‚úÖ All tests passed successfully!${NC}"
    exit 0
fi