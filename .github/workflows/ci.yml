name: CI

on:
  push:
    branches: [ main, develop, 'chore/*' ]
  pull_request:
    branches: [ main ]

env:
  CHITTY_ID_TOKEN: ${{ secrets.CHITTY_ID_TOKEN }}
  NEON_CONNECTION_STRING: ${{ secrets.NEON_CONNECTION_STRING }}
  R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
  R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
  R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
  R2_BUCKET: chittyos-evidence

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Verify no direct AI provider calls
      run: ./scripts/ci/no-direct-models.sh

    - name: Check file permissions
      run: |
        # Ensure scripts are executable
        find . -name "*.sh" -type f | xargs -I {} test -x {} || exit 1

  test-python:
    name: Test Python Components
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify ChittyID service integration
      run: |
        python3 -c "
        import os
        import sys
        if not os.getenv('CHITTY_ID_TOKEN'):
            print('❌ CHITTY_ID_TOKEN not configured in secrets')
            sys.exit(1)
        print('✅ ChittyID token configured')
        "

    - name: Test evidence CLI help
      run: python3 evidence_cli.py --help

    - name: Validate database schema
      run: |
        python3 setup_neon.py
        test -f out/neon_import/01_schema.sql || exit 1
        test -f out/neon_import/02_data.sql || exit 1
        test -f out/neon_import/03_queries.sql || exit 1

  test-node:
    name: Test Node Components
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Node dependencies
      run: npm ci || npm install
      if: hashFiles('package-lock.json') != '' || hashFiles('package.json') != ''

    - name: Test Notion sync script
      run: |
        node -c notion_sync_standalone.js || exit 1
        echo "✅ Notion sync script syntax valid"

  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check for hardcoded secrets
      run: |
        # Check for potential hardcoded secrets
        if grep -r "secret_" . --include="*.py" --include="*.js" | grep -v "NOTION_TOKEN" | grep -v "example" | grep -v "test"; then
          echo "❌ Potential hardcoded secrets found"
          exit 1
        fi
        echo "✅ No hardcoded secrets detected"

    - name: Verify environment variable usage
      run: |
        # Ensure sensitive data comes from environment
        for pattern in "Bearer " "postgresql://" "https://.*\.chitty\.cc"; do
          if grep -r "$pattern" . --include="*.py" --include="*.js" | grep -v "os.getenv" | grep -v "process.env" | grep -v "example"; then
            echo "⚠️ Warning: Found potential hardcoded values for pattern: $pattern"
          fi
        done

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-node]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Test ChittyID service connectivity
      run: |
        curl -f -X POST https://id.chitty.cc/v1/health \
          -H "Authorization: Bearer ${{ secrets.CHITTY_ID_TOKEN }}" \
          || echo "⚠️ ChittyID service health check failed"

    - name: Test database connectivity
      if: env.NEON_CONNECTION_STRING != ''
      run: |
        # This would normally test DB connection
        echo "Database connection test would run here with NEON_CONNECTION_STRING"