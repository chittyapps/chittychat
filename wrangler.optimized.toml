# ChittyOS Platform Orchestrator - Optimized Configuration
# Single worker with intelligent routing to reduce overhead and costs

name = "chittyos-unified-platform"
main = "src/platform-worker.js"
compatibility_date = "2024-09-01"
compatibility_flags = ["nodejs_compat"]
account_id = "0bc21e3a5a9de1a4cc843be9c3e98121"

# Global bindings shared across all services
[ai]
binding = "AI"

# Shared KV namespaces (multi-purpose) - ChittyCorp account
# KV namespaces - temporarily disabled for deployment
# [[kv_namespaces]]
# binding = "PLATFORM_CACHE"
# id = "bf501ad4c5664239878073d54cefb4c1"

# [[kv_namespaces]]
# binding = "PLATFORM_KV"
# id = "b2d174ca8aec43beabae50669f465396"

# GitHub App KV namespaces (create these with: wrangler kv:namespace create <NAME>)
# [[kv_namespaces]]
# binding = "IDEMP_KV"
# id = "to-be-created-idempotency"

# [[kv_namespaces]]
# binding = "TOKEN_KV"
# id = "to-be-created-token-cache"

# [[kv_namespaces]]
# binding = "TENANT_KV"
# id = "to-be-created-tenant-mapping"

# [[kv_namespaces]]
# binding = "RATE_LIMIT_KV"
# id = "to-be-created-rate-limiting"

# Shared R2 buckets - commented until R2 is enabled
# [[r2_buckets]]
# binding = "PLATFORM_STORAGE"
# bucket_name = "chittyos-platform-storage"

# [[r2_buckets]]
# binding = "AUDIT_LOGS"
# bucket_name = "chittyos-audit-logs"

# GitHub Webhook Queue (create with: wrangler queues create github-webhook-queue)
# [[queues.producers]]
# binding = "GITHUB_WEBHOOK_QUEUE"
# queue = "github-webhook-queue"

# Queue consumer for async webhook processing
# [[queues.consumers]]
# queue = "github-webhook-queue"
# max_batch_size = 10
# max_batch_timeout = 30

# Shared Vectorize (multi-dimensional) - commented until enabled
# [[vectorize]]
# binding = "PLATFORM_VECTORS"
# index_name = "chittyos-vectors"

# Shared Hyperdrive (connection pooling) - commented until configured
# [[hyperdrive]]
# binding = "PLATFORM_DB"
# id = "to-be-configured"
# localConnectionString = "postgresql://neondb_owner:pass@ep-little-grass-aexftgdu-pooler.c-2.us-east-2.aws.neon.tech/neondb"

# Shared Durable Objects
[[durable_objects.bindings]]
name = "PLATFORM_STATE"
class_name = "ChittyOSPlatformState"

[[durable_objects.bindings]]
name = "AI_GATEWAY_STATE"
class_name = "AIGatewayState"

[[durable_objects.bindings]]
name = "SYNC_STATE"
class_name = "SyncState"

# Global environment variables
[vars]
PLATFORM_VERSION = "1.0.0"
CHITTYOS_ACCOUNT_ID = "0bc21e3a5a9de1a4cc843be9c3e98121"
MAX_CONCURRENT_REQUESTS = "1000"
CACHE_TTL = "3600"
DEFAULT_MODEL = "@cf/meta/llama-3.1-8b-instruct"
EMBEDDING_MODEL = "@cf/baai/bge-base-en-v1.5"
ROUTER_VERSION = "1.0.0"

# Project Initiation Service
CHITTYID_URL = "https://id.chitty.cc"
DATA_REPO_OWNER = "chitcommit"
DATA_REPO_NAME = "chittychat-data"
CHITTYROUTER_URL = "https://router.chitty.cc"

# GitHub App Configuration
# GITHUB_APP_ID = "your-app-id"
# GITHUB_APP_PK = "your-pem-private-key"
# GITHUB_WEBHOOK_SECRET = "your-webhook-secret"
# MCP_DISPATCH_URL = "https://mcp.chitty.cc/dispatch"
# CHITTYCHAIN_URL = "https://chain.chitty.cc"

# Production Environment (all services on one worker)
[env.production]
name = "chittyos-platform-production"

# Service bindings - ChittySync Hub for todo management
[[env.production.services]]
binding = "CHITTYSYNC_HUB"
service = "chittysync-hub-production"
environment = "production"

routes = [
  # Core services
  { pattern = "gateway.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "sync.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "api.chitty.cc/*", zone_name = "chitty.cc" },

  # AI services
  { pattern = "ai.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "langchain.chitty.cc/*", zone_name = "chitty.cc" },
  # NOTE: mcp.chitty.cc handled by dedicated chittymcp worker
  { pattern = "portal.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "cases.chitty.cc/*", zone_name = "chitty.cc" },

  # Identity & Auth
  # NOTE: id.chitty.cc is handled by dedicated chittyid-production worker (chittyid-worker/)
  # NOTE: auth.chitty.cc is handled by dedicated chittyauth-production worker
  # The unified platform's handleID service acts as a proxy-only backup if needed
  # ZERO local generation - ALL ChittyIDs come from central authority at id.chitty.cc

  # Documentation
  { pattern = "docs.chitty.cc/*", zone_name = "chitty.cc" },

  # Service mesh
  { pattern = "registry.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "canon.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "verify.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "ontology.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "chat.chitty.cc/*", zone_name = "chitty.cc" },

  # Project Management
  { pattern = "projects.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "initiate.chitty.cc/*", zone_name = "chitty.cc" },

  # Monitoring
  { pattern = "beacon.chitty.cc/*", zone_name = "chitty.cc" },

  # Email services
  { pattern = "email.chitty.cc/*", zone_name = "chitty.cc" },
  { pattern = "viewer.chitty.cc/*", zone_name = "chitty.cc" }
]

[env.production.vars]
ENVIRONMENT = "production"
DEBUG_MODE = "false"
RATE_LIMIT_ENABLED = "true"
SECURITY_LEVEL = "strict"
NEON_DATABASE_URL = "placeholder"

# Staging Environment
[env.staging]
name = "chittyos-platform-staging"
routes = [
  { pattern = "staging.chitty.cc/*", zone_name = "chitty.cc" }
]

[env.staging.vars]
ENVIRONMENT = "staging"
DEBUG_MODE = "true"
NEON_DATABASE_URL = "placeholder"

# Development Environment
[env.development]
name = "chittyos-platform-dev"

[env.development.vars]
ENVIRONMENT = "development"
DEBUG_MODE = "true"
RATE_LIMIT_ENABLED = "false"

# Durable Object migrations (SQLite for free plan)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["ChittyOSPlatformState", "AIGatewayState", "SyncState"]

# Cron triggers for scheduled tasks
[triggers]
crons = ["*/1 * * * *"]  # Status update every minute